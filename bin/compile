#!/usr/bin/env bash

echo "Seting up mongo data..."

mkdir mongo
mkdir sandbox_db

chmod -R a+rwX mongo
chmod -R a+rwX sandbox_db

VERSION=3.6.5
FILE_NAME="mongodb-linux-x86_64-ubuntu1604-${VERSION}"

echo "Downloading mongodb version $VERSION ..."
download_url="https://fastdl.mongodb.org/linux/${FILE_NAME}.tgz"
curl ${download_url} -s -o - | tar xzf - -C mongo

chmod -R a+rwX mongo/${FILE_NAME}
chmod +x mongo/${FILE_NAME}/bin/*
cd mongo/${FILE_NAME}/bin/

echo "Dumping data ..."

dump_protocol="$(echo ${MONGODB_URI} | grep :// | sed -e's,^\(.*://\).*,\1,g')"
dump_url="$(echo ${MONGODB_URI/$dump_protocol/})"
dump_userAndPass="$(echo $dump_url | grep @ | cut -d@ -f1)"
dump_user=$(echo $dump_userAndPass | cut -d: -f1)
dump_pass=$(echo $dump_userAndPass | cut -d: -f2)
dump_host="$(echo ${dump_url/$dump_userAndPass@/} | cut -d/ -f1)"
dump_db="$(echo $dump_url | grep / | cut -d/ -f2-)"

./mongodump -h ${dump_host} -d ${dump_db} -u ${dump_user} -p ${dump_pass} -o sandbox_db

echo "Restoring data ..."

protocol="$(echo ${MONGOLAB_COBALT_URI} | grep :// | sed -e's,^\(.*://\).*,\1,g')"
url="$(echo ${MONGOLAB_COBALT_URI/$protocol/})"
userAndPass="$(echo $url | grep @ | cut -d@ -f1)"
user=$(echo $userAndPass | cut -d: -f1)
pass=$(echo $userAndPass | cut -d: -f2)
host="$(echo ${url/$userAndPass@/} | cut -d/ -f1)"
db="$(echo $url | grep / | cut -d/ -f2-)"

./mongorestore -h ${host} -d ${db} -u ${user} -p ${pass} sandbox_db/${dumped_db}

echo "Seting up mongo data done..."
