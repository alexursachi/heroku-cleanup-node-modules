#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

BUILD_DIR=$1
ENV_DIR=$3

echo "Cleaning up..."

rm -rf $BUILD_DIR/node_modules
rm -rf $BUILD_DIR/project/target/node-modules
rm -rf $BUILD_DIR/modules/*/target

echo "Cleanup done..."

echo "Seting up mongo data..."

mkdir mongo
chmod -R a+rwX mongo

VERSION=3.6.5
FILE_NAME="mongodb-linux-x86_64-ubuntu1604-${VERSION}"

echo "Downloading mongodb version $VERSION ..."
download_url="https://fastdl.mongodb.org/linux/${FILE_NAME}.tgz"
curl ${download_url} -s -o - | tar xzf - -C mongo

chmod -R a+rwX mongo/${FILE_NAME}
chmod +x mongo/${FILE_NAME}/bin/*
cd mongo/${FILE_NAME}/bin/

echo "Dumping data ..."

mkdir sandbox_db
chmod -R a+rwX sandbox_db

MONGODB_URI=$(cat $ENV_DIR/MONGODB_URI)
MONGOLAB_COBALT_URI=$(cat $ENV_DIR/MONGOLAB_COBALT_URI)

echo "Dumping from ${MONGODB_URI}"
echo "Into ${MONGOLAB_COBALT_URI}"

dump_protocol="$(echo ${MONGODB_URI} | grep :// | sed -e's,^\(.*://\).*,\1,g')"
dump_url="$(echo ${MONGODB_URI/$dump_protocol/})"
dump_userAndPass="$(echo $dump_url | grep @ | cut -d@ -f1)"
dump_user=$(echo $dump_userAndPass | cut -d: -f1)
dump_pass=$(echo $dump_userAndPass | cut -d: -f2)
dump_host="$(echo ${dump_url/$dump_userAndPass@/} | cut -d/ -f1)"
dump_db="$(echo $dump_url | grep / | cut -d/ -f2-)"

./mongodump --host=${dump_host} --db=${dump_db} --username=${dump_user} --password=${dump_pass} -out=sandbox_db

echo "Restoring data ..."

protocol="$(echo ${MONGOLAB_COBALT_URI} | grep :// | sed -e's,^\(.*://\).*,\1,g')"
url="$(echo ${MONGOLAB_COBALT_URI/$protocol/})"
userAndPass="$(echo $url | grep @ | cut -d@ -f1)"
user=$(echo $userAndPass | cut -d: -f1)
pass=$(echo $userAndPass | cut -d: -f2)
host="$(echo ${url/$userAndPass@/} | cut -d/ -f1)"
db="$(echo $url | grep / | cut -d/ -f2-)"

./mongorestore --host=${host} --db=${db} --username=${user} --password=${pass} sandbox_db/${dump_db}

echo "Seting up mongo data done..."
